name: Build Latest

on:
  push:
    branches: [ main, dev, RSDK-2895 ]
    paths-ignore:
      - 'README.md'

jobs:
  appimage:
    name: AppImage Build
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: [buildjet-2vcpu-ubuntu-2204-arm]
            image: ghcr.io/viamrobotics/canon:arm64-cache
            platform: linux/arm64
    runs-on: ${{ matrix.arch }}
    container:
      image: ${{ matrix.image }}
      options: --platform ${{ matrix.platform }}
    timeout-minutes: 15
    outputs:
      date: ${{ steps.build_date.outputs.date }}
# Trying to use docker here for congruence
# with local dev env. 
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Clean build artifacts
        run: make clean
      - name: Build viam-csi binary and appimage
        run: make image-mod
      - name: Copy binary and appimage from container
        run: make bin-mod
# TODO: push appimage to cloud storage
